<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Position Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Favicon -->
   
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="modern-layout">
        <main class="main-content">
            <header class="modern-header">
                <h1>Trade Position Tracker</h1>
                <span class="subtitle">Track your trades, risk, and profit visually</span>
            </header>
            <div id="tradeModal" class="modal">
                <div class="modal-content">
                    <span class="close" id="closeModal">&times;</span>
                    <h2><i class="fa-solid fa-pen-to-square"></i> Add Trade Position</h2>
                    <form id="tradeForm">
                        <div class="form-row">
                            <label for="tradeType"><i class="fa-solid fa-arrows-up-down"></i> Trade Type:</label>
                            <select id="tradeType" required>
                                <option value="Buy/Long">Buy/Long</option>
                                <option value="Sell/Short">Sell/Short</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label for="symbol"><i class="fa-solid fa-building-columns"></i> Stock Symbol:</label>
                            <input type="text" id="symbol" maxlength="10" required>
                            <button type="button" id="findSymbolBtn" style="margin-left:8px;"><i class="fa-solid fa-magnifying-glass"></i> Find</button>
                        </div>
                        <div class="form-row">
                            <label for="entryPrice"><i class="fa-solid fa-arrow-right-arrow-left"></i> Entry Price:</label>
                            <input type="number" id="entryPrice" step="0.01" required>
                        </div>
                        <div class="form-row">
                            <label for="lotSize"><i class="fa-solid fa-layer-group"></i> Lot Size/Qty:</label>
                            <input type="number" id="lotSize" step="1" min="1" required>
                        </div>
                        <div class="form-row">
                            <label for="stopLossType"><i class="fa-solid fa-shield-halved"></i> Stop Loss Type:</label>
                            <select id="stopLossType" required>
                                <option value="Amount">Amount</option>
                                <option value="Percentage">Percentage</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label for="stopLossAmount"><i class="fa-solid fa-money-bill-trend-up"></i> Amount:</label>
                            <input type="number" id="stopLossAmount" step="0.01" required>
                        </div>
                        <div class="form-row">
                            <label for="takeProfitType"><i class="fa-solid fa-bullseye"></i> Take Profit Type:</label>
                            <select id="takeProfitType" required>
                                <option value="Risk-Reward">Risk-Reward</option>
                                <option value="Amount">Amount</option>
                                <option value="Percentage">Percentage</option>
                            </select>
                        </div>
                        <div class="form-row" id="rrOrAmountRow">
                            <label id="rrOrAmountLabel" for="rrOrAmount"><i class="fa-solid fa-scale-balanced"></i> Risk-Reward Ratio:</label>
                            <select id="riskReward" required>
                                <option value="1:1">1:1</option>
                                <option value="1:2">1:2</option>
                                <option value="1:3">1:3</option>
                                <option value="Custom">Custom</option>
                            </select>
                            <input type="number" id="amountReward" style="display:none;" step="0.01" placeholder="Enter amount">
                        </div>
                        <div id="customRiskRewardContainer" style="display:none;" class="form-row">
                            <label for="customRiskReward"><i class="fa-solid fa-sliders"></i> Custom Ratio:</label>
                            <input type="text" id="customRiskReward" placeholder="e.g. 1:2.5">
                        </div>
                        <div id="manualTargetContainer" style="display:none;" class="form-row">
                            <label for="manualTarget"><i class="fa-solid fa-bullseye-arrow"></i> Manual Target Price:</label>
                            <input type="number" id="manualTarget" step="0.01" placeholder="Enter target price">
                        </div>
                        <div class="form-row">
                            <label for="dateOpened"><i class="fa-solid fa-calendar-day"></i> Date Opened:</label>
                            <input type="datetime-local" id="dateOpened">
                        </div>
                        <button type="submit" class="main-btn"><i class="fa-solid fa-save"></i> Save Trade</button>
                    </form>
                    <div id="result"></div>
                </div>
            </div>
            <section class="card card-table">
                <div class="grid-actions" style="display:flex; gap:16px; margin-bottom:18px;">
                    <button id="addTradeBtn" class="main-btn"><i class="fa-solid fa-plus"></i> Add Position</button>
                    <button id="importBtn" class="main-btn" title="Import"><i class="fa-solid fa-file-import"></i> Import</button>
                    <button id="exportBtn" class="main-btn" title="Export"><i class="fa-solid fa-file-export"></i> Export</button>
                </div>
                <h2><i class="fa-solid fa-table-list"></i> Trade History</h2>
                <div class="table-responsive">
                    <table id="tradeTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Date Opened</th>
                                <th>Trade Type</th>
                                <th>Symbol</th>
                                <th>Entry Price</th>
                                <th>Qty</th>
                                <th>Current Price</th>
                                <th>Current Valuation</th>
                                <th>Stop Loss Type</th>
                                <th>Stop Loss Amount</th>
                                <th>Take Profit Type</th>
                                <th>Risk-Reward</th>
                                <th>Position Value</th>
                                <th>Potential Loss</th>
                                <th>Potential Profit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Trades will be rendered by JS -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // Simple symbol search using Yahoo Finance API
        // This is a demo and may need a proxy for CORS in production

        document.getElementById('findSymbolBtn').onclick = async function() {
            const query = document.getElementById('symbol').value.trim();
            if (!query) {
                alert('Enter company name or symbol to search.');
                return;
            }
            try {
                const res = await fetch(`/api/lookup?query=${encodeURIComponent(query)}`);
                
                const data = await res.json();
                if (data && data.symbol) {
                    document.getElementById('symbol').value = data.symbol;
                    alert(`Found symbol: ${data.symbol} (${data.name || ''})`);
                } else {
                    alert('No symbol found.');
                }
            } catch (e) {
                alert('Error fetching symbol.');
            }
        };

        // Export trades to JSON file
        document.getElementById('exportBtn').onclick = function() {
            if (typeof window.localStorage !== 'undefined') {
                const trades = localStorage.getItem('trades');
                if (!trades) {
                    alert('No trades to export.');
                    return;
                }
                const blob = new Blob([trades], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'trades.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        };

        // Import trades from JSON file
        document.getElementById('importBtn').onclick = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,application/json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    try {
                        const data = JSON.parse(evt.target.result);
                        localStorage.setItem('trades', JSON.stringify(data));
                        alert('Trades imported! Please refresh the page to see changes.');
                    } catch (err) {
                        alert('Invalid JSON file.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        // Add current price to each row using Python backend API
        function updateCurrentPrices() {
            const rows = document.querySelectorAll('#tradeTable tbody tr');
            rows.forEach(row => {
                const symbolCell = row.children[3]; // Symbol column
                const priceCell = row.children[6]; // Current Price column
                if (symbolCell && priceCell) {
                    const symbol = symbolCell.textContent.trim();
                    if (symbol) {
                        fetch(`/api/price?symbol=${encodeURIComponent(symbol)}`)
                            .then(res => res.json())
                            .then(data => {
                                let price = 'N/A';
                                if (data && data.price !== undefined && data.price !== null) {
                                    price = data.price;
                                }
                                priceCell.textContent = price !== undefined ? price : 'N/A';
                            })
                            .catch(() => {
                                priceCell.textContent = 'N/A';
                            });
                    }
                }
            });
        }
        // Call after table is rendered
        setTimeout(updateCurrentPrices, 500);

        document.getElementById('toggleSidebarBtn').onclick = function() {
    const sidebar = document.querySelector('.sidebar');
    const arrow = document.getElementById('sidebarArrow');
    if (sidebar.style.display === 'none') {
        sidebar.style.display = '';
        arrow.classList.remove('fa-chevron-right');
        arrow.classList.add('fa-chevron-left');
    } else {
        sidebar.style.display = 'none';
        arrow.classList.remove('fa-chevron-left');
        arrow.classList.add('fa-chevron-right');
    }
};
    </script>
</body>
</html>
